{% set selected = "projetos" %}
{% extends 'base.html' %}

{% block extra_head %}
   
<link
   rel="stylesheet" type="text/css"
   href="{{ url_for('.static', filename='css/register.css') }}">
<link
   rel="stylesheet" type="text/css"
   href="{{ url_for('.static', filename='css/projetos.listing.css') }}">
<script
   type="text/javascript"
   src="{{ url_for('.static', filename='js/inc/jquery.js') }}"></script>
<script
   type="text/javascript"
   src="{{ url_for('.static', filename='js/projetos.listing.js') }}"></script>
{% endblock %}

{% block contenttitle %}<h2>Projetos</h2>{% endblock %}

{% block container %}

<div class="main container">
  <form id="lista_projetos" method="get">
    <ul>
      <li class="busca">
        <div class="column">
          <label>Nome:</label>
          <input name="nome" id="nome" class="textarea medium" value="{{ cvars.nome }}" />
        </div>      
        <div class="column">
          <label>Cidade:</label>
          <input name="cidade" id="cidade" class="textarea medium" value="{{ cvars.cidade }}" />
        </div>
        <div class="column">
          <label>Estado:</label>
          <select name="uf">
            <option value=""></option>
            {% for v, uf in vals_uf %}
            <option value="{{ v }}" {% if v == cvars.uf %}selected="selected"{% endif %}>{{ uf }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="column">
          <label>Limite:</label>
          <select name="limit" class="small">
            {% for l in limites %}
            <option value="{{ l }}" {% if l == cvars.limit %}selected="selected"{% endif %}>{{ l }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="column last">
          <label>&nbsp;</label>
          <input type="submit" value="Buscar" />
        </div>
      </li>
    </ul>

    {% if projetos %}

    <div id="sumarioProjetos">
      <p>
        Exibindo <strong>{{ pagination.display }}</strong> de um total de
        <strong>{{ pagination.count }}</strong> projetos.
      </p>
    </div>

    <div class="tablecontent">
      <table id="projetos">
        <thead>
          <tr>
            <th class="{{ cvars.nome_class }}" id="nome">Nome</th>
            <th class="{{ cvars.responsavel_por_class }}" id="responsavel_por">Cadastrado por</th>
            <th class="{{ cvars.cidade_class }}" id="cidade">Cidade</th>
            <th class="{{ cvars.uf_class }}" id="uf">UF</th>
            <th class="{{ cvars.data_cadastro_class }}" id="data_cadastro">Data do cadastro</th>
          </tr>
        </thead>
        <tbody>
          {% for projeto in projetos %}
          <tr onclick="showProject({{ projeto.id }}, this)">
            <td style="width: 360px; max-width: 360px;">
              <a>
                {{ projeto.nome }}
              </a>
            </td>
            <td>{{ projeto.responsavel_por }}</td>
            <td style="width: 150px; max-width: 150px;">{{ projeto.enderecos.0.cidade }}</td>
            <td style="width: 50px;">{{ projeto.enderecos.0.uf }}</td>
            <td>{{ projeto.data_cadastro.strftime('%d/%m/%Y %H:%M') }}</td>
          </tr>
          <tr class="detalhesProjeto hidden">
            <td colspan="5">
              <fieldset class="endereco">
                <legend>Endere√ßo</legend>
                <ul>
                  <li><a class="logradouro"></a></li>
                  <li><a class="bairro"></a></li>
                  <li><a class="cidade"></a> - <a class="uf"></a></li>
                </ul>
              </fieldset>

              <fieldset class="contatos hidden">
                <legend>Contatos</legend>
                <div class="email">
                  <label>Email</label> <a href=""></a>
                </div>
                <div class="site">
                  <label>Site</label>
                  <a href=""></a>
                </div>
                <div class="telefones">
                  <strong>Telefones</strong>
                  <ul></ul>
                </div>
              </fieldset>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="margin-top: 10px;">
      <ul>
        <li>
          {% for i in range(1, pagination['pages']) %}
          <a href="javascript: $('input[name=page]').val('{{ i }}'); FORM.submit()"
             {% if i == pagination['page'] %}
             class="selected"
             {% endif %}>{{ i }}</a>
          {% endfor %}
          <input type="hidden" name="page" />
        </li>
      </ul>
    </div>
    
    {% else %}
      <h3>Nenhum projeto cadastrado no momento.</h3>
    {% endif %}
    
    <input type="hidden" name="order_by" value="{{ cvars.order_by }}" />
    
  </form>
  <script type="text/javascript">
    var FORM = document.getElementById('lista_projetos');
    
    function appendOrderBy(newob) {
        var $orderby = $("input[name=order_by]");
        var obys = $orderby.val().split(' ');
        var n = newob.replace('-', '').replace(' ', '');
        for (var k = 0; k < obys.length; k++) {
            if (n == obys[k].replace('-', '').replace(' ', '')) {
                obys.splice(k,1);
                break;
            }
        }
        return newob.replace(' ', '') + " " + obys.join(' ');
    }
    
    $("table th").each(function() {
        $(this).click(function() {
            var n = $(this).attr('id');
            var $orderby = $("input[name=order_by]");
            var minus = " ";
            if ($(this).hasClass('arrowdown')) {
                minus = "-";
            }
            $orderby.val(appendOrderBy(minus + n));
            FORM.submit();
        });
    });
  </script>
</div>


{% endblock %}
